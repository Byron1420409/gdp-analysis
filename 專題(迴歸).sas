title 'Factors that Predict Car Price';
data mtcars; /*??*/
input y x1 x2 x3 x4 x5 x6 x7 x8 x9 x10 x11;
label y='gdp' x1='peo_15-64' x2='peo_total'
x3='une'
x4='pe_per' x5='oc' x6='gc' x7='cc' x8='nuc' x9='rec' x10='out' x11='in';
cards;
2.17763E+13	64.73724829	334914895	3.625	277.300213	35.85838318	31.91281891	8.196724892	7.323962688	10.98922968	92880420155	39962812007
1.68114E+13	68.9454422	1410710000	4.67	119.7605825	32.72583771	14.57417202	91.93867493	3.901064873	27.59948204	79902088071	64796847899
3.97788E+12	58.46348166	124516650	2.575	141.1558785	6.654957771	3.327148438	4.536397934	0.695111394	2.190129761	21240933684	37918548843
3.53028E+12	63.26433759	84482267	3.045	136.9881678	4.012256622	2.723897219	1.825999975	0.064754516	2.783470828	5735477971	11307691769
2.61382E+12	63.32507106	68350000	4.055	102.6049941	2.688408852	2.286126852	0.183722794	0.365666509	1.426209165	2933959178	2289060203
2.58934E+12	60.95884242	68170228	7.323	133.791471	2.764375448	1.219109893	0.177777156	3.034939766	1.467676364	1461357820	3806666726
2.08846E+12	68.02755905	1428627663	4.172	27.31032215	10.57310772	2.2539711	21.98124695	0.432574093	3.775381847	6337088711	2300540558
1.93408E+12	63.34130546	58761146	7.618	100.9867053	2.472746372	2.109514952	0.216783494	0	1.146119477	1961324867	2845143323
1.6861E+12	65.04903015	40097761	5.366	359.6990108	4.351797104	4.346180439	0.370707989	0.798811793	4.082095046	2135630178	1656492906
1.61775E+12	64.78578147	26638544	3.667	227.7247928	2.165953159	1.444374084	1.508440375	0	0.902073456	4814141039	12424572735
1.52838E+12	70.38654405	51712619	2.642	240.1129139	5.363492966	2.162689447	2.69405508	1.619707346	0.594076462	16818398814	34937829895
1.40792E+12	67.39250455	128455567	2.812	65.80452139	3.837449551	3.51261878	0.263958752	0.111149818	0.72778014	6459117657	2032564652
1.32219E+12	65.79929314	48373336	12.144	119.1572349	2.568294525	1.054738998	0.118553996	0.509744048	1.41097591	1170328152	914782436
1.1219E+12	66.26643828	143826130	3.325	216.6313575	7.211546421	16.32135391	3.833892584	1.950732827	1.973651829	500005134	3842205927
9.2498E+11	71.35175972	36947025	4.88	313.9151633	7.431258678	4.108518124	0.004503026	0	0.053951558	779670232	7179781561
8.92982E+11	69.78451925	216422446	7.95	64.10320637	5.108195305	1.079567432	0.572737515	0.130208984	6.982663482	981137127	2130413918
8.72963E+11	63.92618163	17879488	3.561	195.0406764	1.703104615	0.9278	0.158369079	0.035750724	0.611260536	8351402754	3867558013
8.5258E+11	65.33150787	8849852	4.05	128.7668935	0.386569321	0.098788418	0.00385	0.209393278	0.434118724	480685501	2164716560
8.07343E+11	68.09331797	277534122	3.417	36.42017016	3.096230984	1.636019468	4.319662571	0	1.055926925	2504772836	6434365389
5.68128E+11	66.5255572	36685849	2.905	100.3365838	1.405194998	0.704977691	1.505949259	0	0.500293461	1415290057	348393339
5.10215E+11	63.56722579	11822592	5.508	197.7922054	1.134389281	0.493420929	0.098620348	0.295487583	0.289509263	1768256679	830423522
4.70704E+11	65.32454593	5262382	4.34	128.6867218	0.30480206	0.173643678	0.027176723	0	0.145137798	1133486573	753367131
4.65069E+11	62.15359544	10536632	7.587	202.6942094	0.466199607	0.02578317	0.065215506	0.434627801	1.159182298	547001288	616637298
4.57122E+11	82.91803577	9516871	2.706	539.3891782	2.203999996	2.407959223	0.102262266	0.28962037	0.129455373	1327373974	3277813557
4.41276E+11	59.88719627	9756700	3.389	121.4289507	0.444611549	0.452421308	0.138301462	0	0.078718018	836423171	1135674421
4.08076E+11	65.42315931	9132383	5.243	154.6294295	0.48610127	0.247726023	0.09625309	0	0.555238491	446047046	627086605
3.9639E+11	72.18019018	5917648	3.472	576.997372	2.994141817	0.443930209	0.014075815	0	0.018331524	27094091624	7960212134
3.78422E+11	64.38887397	117337368	2.233	18.69113659	0.933131039	0.115334108	0.881716013	0	0.262987612	3550343723	2056535931
3.6416E+11	66.75781977	7536100	3.931	120.5894744	0.573551238	0.174484089	0.146899	0	0.008474745	42981884567	1078194398
3.5443E+11	63.33392997	5946952	5.142	119.0819512	0.315262258	0.058689035	0.029128326	0	0.300803434	294393596	612261758
3.43494E+11	69.79563971	34308525	3.855	140.11	1.79	1.66	0.98	0	0.38	15837872902	12194866981
3.32629E+11	64.82139465	5519594	3.581	363.7142227	0.384520888	0.136555567	0.034618374	0	1.435407763	160505486	306439110
3.17247E+11	62.46696133	112716598	7.306	34.93318162	1.493851781	2.161597967	0.050125577	0	0.231974065	243,510,062	18,828,255
3.12701E+11	68.20552252	172954319	5.06	10.58407442	0.517730534	1.012531996	0.281846225	0	0.018452629	829882981	97469376
3.12543E+11	68.81669336	71801279	0.913	69.73307985	2.310999632	1.698270679	0.60497272	0	0.392681291	10007198337	5268102846
2.50779E+11	65.84894623	60414495	27.988	80.33003846	1.085890293	0.170911804	3.325293064	0.079889111	0.191114354	596444279	721324962
2.50007E+11	61.46905012	5584264	7.155	215.6282071	0.327256262	0.042998999	0.088483997	0.307309747	0.429711611	151438330	254120716
2.45119E+11	68.25657414	98858950	1.602	49.47893321	1.195236921	0.259855211	2.323306322	0	1.113036931	11715595792	6500483098
2.4254E+11	68.3516696	19629590	9.037	92.44427364	0.832459629	0.25252068	0.175611407	0	0.554051474	130370194	905282577
2.38586E+11	63.42068517	10873689	2.593	145.2214262	0.417624772	0.241109997	0.470816165	0.272895634	0.12169514	1,552,604,866	483,634,222
2.29537E+11	63.68011843	10525347	6.491	92.55325082	0.445088744	0.161297679	0.00020934	0	0.341853393	526071301	178472399
2.26135E+11	69.5099483	52085168	9.565	43.30114139	0.97713536	0.469959766	0.156074464	0	0.652177634	197034114	321855292
2.103E+11	63.25245905	10361295	10.997	106.2394518	0.619487643	0.193759203	0.047603406	0	0.237801347	152355024	173344252
1.91909E+11	64.7574611	5223100	3.737	164.664997	0.319015414	0.136997133	0.04100265	0	0.363869874	335805056	896209808
1.80767E+11	62.94245946	45606480	11.814	55.6502041	0.857524216	1.666664958	0.006958742	0	0.006862005	74654876	59268
1.64875E+11	59.50918799	240485658	5.499	14.02214794	0.78187865	1.362399101	0.617098093	0.200766072	0.409983557	253460404	69086679
1.57494E+11	59.28127862	45504560	15.529	55.19872287	1.802909613	0.673253953	0	0	0.035630031	92931580	399730188
1.5059E+11	65.74485219	34352719	4.82	36.03105426	0.518804133	0.363521397	0.029294347	0	0.326144805	136899369	524933242
1.31058E+11	74.42844523	4310108	2.076	365.9318286	0.761769354	0.808381557	0.005518311	0	0.001536479	106646292	2752091438
1.23562E+11	65.87350396	9589872	4.126	89.65509971	0.336751133	0.294654012	0.036347792	0.142842457	0.099963227	733172401	278294269
1.20983E+11	65.68739983	37840044	9.114	25.80894823	0.570543766	0.031968385	0.29162693	0	0.082472655	74702806	46054450
;
proc gplot; /*???*/
plot y*(x1-x11);
symbol1 v=star c=red;
symbol2 v=dot c=blue;
run;
proc corr; /*Correlation Coefficient*/
var y x1 x2 x3 x4 x5 x6 x7 {x8 x9 x10};
run;
proc reg; /*FULL MODEL*/
model y = x1 x2 x3 x4 x5 x6 x7 x8 x9 x10 x11/vif;
run;
proc reg; /*??????????( 2 Radj selection)*/
model y = x1 x2 x3 x4 x5 x6 x7 x8 x9 x10 x11/ selection=adjrsq;
run;
proc reg; /*x3 x4 x5 x7 x8 x9 x10 MODEL*/
model y =x1 x2 x5 x6 x8 x9 x10/vif;
run;
proc reg; /*?????(FORWARD selection)*/
model y = x1 x2 x3 x4 x5 x6 x7 x8 x9 x10 x11/ selection=forward;
run;
proc reg; /*x3 x4 x5 x7 x8 x9 x10 MODEL*/
model y = x1 x2 x3 x4 x5 x6 x7 x8 x9 x10 x11/vif;
run;
proc reg; /*?????(BACKWARD selection) */
model y = x1 x2 x3 x4 x5 x6 x7 x8 x9 x10 x11 / selection=backward;
run;
proc reg; /*x3 x4 x5 x7 x8 x9 x10 MODEL*/
model y = x1 x2 x5 x6 x8 x10/vif;
run;
proc reg; /*?????(STEPWISE selection) */
model y = x1 x2 x3 x4 x5 x6 x7 x8 x9 x10 x11/ selection=stepwise;
run;
proc reg; /*x3 x4 x5 x7 x8 x9 x10 MODEL*/
model y = x1 x2 x5 x6 x8 x10/vif;
run;
proc reg; /*CP ???*/
model y = x1 x2 x3 x4 x5 x6 x7 x8 x9 x10 x11/ selection=cp;
run;
proc reg; /*x3 x4 x5 x7 x8 x9 x10 MODEL*/
model y = x1 x2 x5 x6 x8 x10/vif;
run;
proc reg; /* ????????????? */
    model y = x1 x2 x6 x8 x10 / vif;
    output out=residuals r=residual; /* ?????? residuals ??? */
run;

/**殘差檢定*/
data residuals; /* ???? */
set residuals;
residual_x6 = residual;
residual_x7 = residual;
run;
proc ttest data=residuals; /* 看其期望值的數值 */
var residual_x6 residual_x7;
run;
proc univariate data=residuals normal; /* ???????????? */
var residual_x6 residual_x7;
qqplot residual_x6 / normal(mu=est sigma=est);
qqplot residual_x7 / normal(mu=est sigma=est);
run;
proc autoreg data=residuals;
model residual_x6 = / dw=2;
model residual_x7 = / dw=2;
run;
proc reg data=residuals; /* ??????????? */
model residual_x6 residual_x7 = x1 x2  x5 x6  x8 x10;
output out=heteroscedasticity;
run;
proc reg; /*???*/
model lny=x6 x7/p r influence;
output out=all student=student rstudent=rstudent;
plot (student. rstudent. )*(x6 x7 predicted.);
plot student. *nqq./vaxis=-4 to 4 by 1 haxis=-3 to 3 by 1.0;
run;

/****/
proc reg data=residuals; 
    /* 以 y 為應變數，並生成殘差 */
    model y = x1 x2 x5 x6 x8 x10 / vif;
    output out=res_out r=residual p=predicted; /* 生成殘差與預測值 */
run;

proc sgplot data=res_out;
    /* 繪製變異數散點圖：殘差對預測值 */
    scatter x=predicted y=residual / markerattrs=(symbol=circlefilled color=blue);
    refline 0 / axis=y lineattrs=(pattern=shortdash color=red); /* 添加基準線 y=0 */
    xaxis label="Predicted Values";
    yaxis label="Residuals" grid;
    title "Residuals vs Predicted Values";
run;

/***new_data**/

data mtcars_new; /*??*/
input y x1 x2 x3 x4 x5 x6 x7 x8 x9 x10 x11;
label y='gdp' x1='peo_15-64' x2='peo_total'
x3='une'
x4='pe_per' x5='oc' x6='gc' x7='cc' x8='nuc' x9='rec' x10='out' x11='in';
cards;
21776284673936.20 	64.73724829	334914895	3.625	3497676637	6343963243	6084915987	21429935487	277.30 	35.86 	31.91 	8.20 	7.32 	10.99 
16811419909308.30 	68.9454422	1410710000	4.67	47272695166	1775801275	1303008631	358784566	119.76 	32.73 	14.57 	91.94 	3.90 	27.60 
3977876229419.65 	58.46348166	124516650	2.575	15655633218	314733333	322743957	583342136	141.16 	6.65 	3.33 	4.54 	0.70 	2.19 
3530283247614.18 	63.26433759	84482267	3.045	1629435694	374110720	225499451	874633481	136.99 	4.01 	2.72 	1.83 	0.06 	2.78 
2613824665777.60 	63.32507106	68350000	4.055	64294252	202192123	474679964	188118501	102.60 	2.69 	2.29 	0.18 	0.37 	1.43 
2589336810981.44 	60.95884242	68170228	7.323	243692575	49558112	158600295	81136437	133.79 	2.76 	1.22 	0.18 	3.03 	1.47 
2088457025259.45 	68.02755905	1428627663	4.172	1956415197	98945846	210972270	140046590	27.31 	10.57 	2.25 	21.98 	0.43 	3.78 
1934079250413.76 	63.34130546	58761146	7.618	68250709	30528323	107984844	41542324	100.99 	2.47 	2.11 	0.22 	0.00 	1.15 
1686099533122.04 	65.04903015	40097761	5.366	78957624	67640356	48877872	132711398	359.70 	4.35 	4.35 	0.37 	0.80 	4.08 
1617745561254.02 	64.78578147	26638544	3.667	7648342	89955889	137181269	129899012	227.72 	2.17 	1.44 	1.51 	0.00 	0.90 
1528382258049.07 	70.38654405	51712619	2.642	11375815089	242252177	109440644	261417317	240.11 	5.36 	2.16 	2.69 	1.62 	0.59 
1407921613931.91 	67.39250455	128455567	2.812	642488801	714850545	341608574	209658995	65.80 	3.84 	3.51 	0.26 	0.11 	0.73 
1322187171601.98 	65.79929314	48373336	12.144	2389756	14674226	94343931	17063721	119.16 	2.57 	1.05 	0.12 	0.51 	1.41 
924979877600.00 	71.35175972	36947025	4.88	204817	6383008	18494814	11939127	313.92 	7.43 	4.11 	0.00 	0.00 	0.05 
892982293958.41 	69.78451925	216422446	7.95	201186482	36462989	9559852	13481227	64.10 	5.11 	1.08 	0.57 	0.13 	6.98 
872962750787.85 	63.92618163	17879488	3.561	475875306	795255852	680258010	6130633991	195.04 	1.70 	0.93 	0.16 	0.04 	0.61 
852579889592.54 	65.33150787	8849852	4.05	100202174	8999572	49777568	14834551	128.77 	0.39 	0.10 	0.00 	0.21 	0.43 
807343093607.49 	68.09331797	277534122	3.417	345289485	40513304	35778133	22867166	36.42 	3.10 	1.64 	4.32 	0.00 	1.06 
568128017752.12 	66.5255572	36685849	2.905	101946763	30203789	165991146	174725953	100.34 	1.41 	0.70 	1.51 	0.00 	0.50 
510214767175.70 	63.56722579	11822592	5.508	687546036	16819329	33087980	18114704	197.79 	1.13 	0.49 	0.10 	0.30 	0.29 
470704052408.67 	65.32454593	5262382	4.34	77007997	251363719	207636876	135816727	128.69 	0.30 	0.17 	0.03 	0.00 	0.15 
465068990195.54 	62.15359544	10536632	7.587	145644605	11746978	54397414	42909269	202.69 	0.47 	0.03 	0.07 	0.43 	1.16 
457121579305.65 	82.91803577	9516871	2.706	1143348	42513018	166414343	91857390	539.39 	2.20 	2.41 	0.10 	0.29 	0.13 
441275679010.82 	59.88719627	9756700	3.389	327739486	47914079	71530419	65732027	121.43 	0.44 	0.45 	0.14 	0.00 	0.08 
408075991714.79 	65.42315931	9132383	5.243	92428142	27068621	19466117	10409118	154.63 	0.49 	0.25 	0.10 	0.00 	0.56 
396390066184.23 	72.18019018	5917648	3.472	21095448231	401633549	283613325	1039753806	577.00 	2.99 	0.44 	0.01 	0.00 	0.02 
378422090152.46 	64.38887397	117337368	2.233	2612223802	61656500	26909381	22775568	18.69 	0.93 	0.12 	0.88 	0.00 	0.26 
354429778583.05 	63.33392997	5946952	5.142	10217247	9438095	26012256	17888948	119.08 	0.32 	0.06 	0.03 	0.00 	0.30 
343493848968.24 	69.79563971	34308525	3.855	8713173217	380695890	83725013	498676962	140.11 	1.79 	1.66 	0.98 	0.00 	0.38 
332628526349.01 	64.82139465	5519594	3.581	3361271	16214088	36122814	13665196	363.71 	0.38 	0.14 	0.03 	0.00 	1.44 
317246908189.13 	62.46696133	112716598	7.306	39648490	292401	25830850	1897124	34.93 	1.49 	2.16 	0.05 	0.00 	0.23 
312701418475.38 	68.20552252	172954319	5.06	552043	6792154	722775	1263840	10.58 	0.52 	1.01 	0.28 	0.00 	0.02 
312543386279.52 	68.81669336	71801279	0.913	2381089179	125229644	126348775	3925857681	69.73 	2.31 	1.70 	0.60 	0.00 	0.39 
250778982174.98 	65.84894623	60414495	27.988	3690811	7813443	40383396	11154464	80.33 	1.09 	0.17 	3.33 	0.08 	0.19 
250006606964.71 	61.46905012	5584264	7.155	128841699	10437697	8769740	16179136	215.63 	0.33 	0.04 	0.09 	0.31 	0.43 
245119044602.76 	68.25657414	98858950	1.602	2759110604	122869529	79015948	42281451	49.48 	1.20 	0.26 	2.32 	0.00 	1.11 
242540346347.47 	68.3516696	19629590	9.037	36732	2359133	2485895	1511238	92.44 	0.83 	0.25 	0.18 	0.00 	0.55 
238586454536.24 	63.42068517	10873689	2.593	10878070	139090506	57388041	129639555	145.22 	0.42 	0.24 	0.47 	0.27 	0.12 
229536873780.61 	63.68011843	10525347	6.491	154209291	2981154	13994181	4392504	92.55 	0.45 	0.16 	0.00 	0.00 	0.34 
226135090806.76 	69.5099483	52085168	9.565	25503	3580865	961360	2528574	43.30 	0.98 	0.47 	0.16 	0.00 	0.65 
210300269077.60 	63.25245905	10361295	10.997	203476	802658	492559	1167627	106.24 	0.62 	0.19 	0.05 	0.00 	0.24 
191909270613.75 	64.7574611	5223100	3.737	1456381	11506649	11662100	12039709	164.66 	0.32 	0.14 	0.04 	0.00 	0.36 
180767432151.95 	62.94245946	45606480	11.814	503217	708036	5310136	841303	55.65 	0.86 	1.67 	0.01 	0.00 	0.01 
164875307428.49 	59.50918799	240485658	5.499	1455	839104	688632	2807515	14.02 	0.78 	1.36 	0.62 	0.20 	0.41 
157494470834.13 	59.28127862	45504560	15.529	0	691216	73734	1038123	55.20 	1.80 	0.67 	0.00 	0.00 	0.04 
150590331922.48 	65.74485219	34352719	4.82	25805	6387485	299263	1695082	36.03 	0.52 	0.36 	0.03 	0.00 	0.33 
131057831599.85 	74.42844523	4310108	2.076	21309	990687	1340545	1434117	365.93 	0.76 	0.81 	0.01 	0.00 	0.00 
123562187932.20 	65.87350396	9589872	4.126	68134130	52184384	74739742	89889152	89.66 	0.34 	0.29 	0.04 	0.14 	0.10 
120982651814.52 	65.68739983	37840044	9.114	4443486	766791	7049103	1396087	25.81 	0.57 	0.03 	0.29 	0.00 	0.08 
;
proc reg; /* 將模型應用於新數據 */
model y = x1 x2 x6 x8 x10 / vif;
output out=new_results p=new_predicted r=new_residuals;
run;

proc sgplot data=new_results;
    scatter x=new_predicted y=new_residuals / markerattrs=(symbol=circle color=green);
    refline 0 / axis=y lineattrs=(pattern=solid color=black);
    xaxis label="New Predicted Values";
    yaxis label="New Residuals";
    title "New Residuals vs Predicted Values";
run;


data new_gdp;
set mtcars;
	if _n_ in (1,7,14,29) then delete;
run;
